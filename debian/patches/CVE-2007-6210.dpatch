#! /bin/sh /usr/share/dpatch/dpatch-run
# DP: fix UserParameter execution with gid 0.

@DPATCH@
--- zabbix-1.1.4/src/zabbix_agent/zabbix_agentd.c	2006-11-14 18:11:18.000000000 +0000
+++ zabbix_agentd.c	2007-12-03 08:23:03.000000000 +0000
@@ -184,23 +184,32 @@
 	int     i;
 	pid_t   pid;
 	struct passwd   *pwd;
+	char user[7] = "zabbix";
 
 	/* running as root ?*/
 	if((getuid()==0) || (getgid()==0))
 	{
-		pwd = getpwnam("zabbix");
+		pwd = getpwnam(user);
 		if ( pwd == NULL )
 		{
 			fprintf(stderr,"User zabbix does not exist.\n");
 			fprintf(stderr, "Cannot run as root !\n");
 			exit(FAIL);
 		}
+
+		if( (initgroups(user, pwd->pw_gid) == -1) ) 
+		{
+			fprintf(stderr, "Cannot initgroups to zabbix [%s].", strerror(errno));
+			exit(FAIL);
+		}
+		
 		if( (setgid(pwd->pw_gid) ==-1) || (setuid(pwd->pw_uid) == -1) )
 		{
 			fprintf(stderr,"Cannot setgid or setuid to zabbix [%s]\n", strerror(errno));
 			exit(FAIL);
 		}
 
+
 #ifdef HAVE_FUNCTION_SETEUID
 		if( (setegid(pwd->pw_gid) ==-1) || (seteuid(pwd->pw_uid) == -1) )
 		{
